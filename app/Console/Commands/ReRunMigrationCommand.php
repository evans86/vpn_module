<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\DB;

class ReRunMigrationCommand extends Command
{
    protected $signature = 'migrate:rerun {migration : Ğ˜Ğ¼Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 2025_12_01_212026_optimize_application_logs_indexes)}';

    protected $description = 'Ğ£Ğ´Ğ°Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¾ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ· Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ migrations Ğ¸ Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ĞµÑ‘ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾';

    public function handle(): int
    {
        $migrationName = $this->argument('migration');
        
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ»Ğ¸ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ migrations
        $migration = DB::table('migrations')
            ->where('migration', $migrationName)
            ->first();

        if (!$migration) {
            $this->warn("âš ï¸ ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ '{$migrationName}' Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ° Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ migrations.");
            $this->info("ğŸ’¡ Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ğ¾Ğ½Ğ° ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ±Ñ‹Ğ»Ğ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ: php artisan migrate");
            return 1;
        }

        $this->info("ğŸ“‹ ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ° Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ: {$migrationName}");
        $this->info("   Batch: {$migration->batch}");
        
        if (!$this->confirm('Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¾ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ· Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ migrations?', true)) {
            $this->info('âŒ ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°');
            return 0;
        }

        DB::table('migrations')
            ->where('migration', $migrationName)
            ->delete();

        $this->info("âœ… Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¾ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ° Ğ¸Ğ· Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ migrations");
        $this->newLine();
        $this->info("ğŸ’¡ Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾:");
        $this->line("   php artisan migrate");

        return 0;
    }
}

